% Criação de um vetor de 3 vetores de imagens onde são armazendas 
% todas as imagens originais, os GT do ROI e o GT da segmentaçao 
clear;clc;

pasta_principal = 'C:\Users\Filipa Pato\OneDrive - Universidade do Porto\Documentos\Faculdade\3º ano\AIBI\projeto\Train1'; 
subpastas = {'cells1', 'images1', 'ROIs1'};
vetores_de_imagens = cell(1,3);

for k = 1:3
    pasta_atual = fullfile(pasta_principal, subpastas{k}); % Caminho completo para a subpasta atual
    arquivos = dir(pasta_atual); % Obtém a lista de arquivos na subpasta atual
    num_imagens = numel(arquivos)-2; % Número total de imagens na subpasta
    image_vector = cell(1, num_imagens); % Vetor de imagens
    for i = 1:num_imagens-2
        nome_arquivo = fullfile(pasta_atual, arquivos(i+2).name); % Caminho completo para o arquivo
        extensao = nome_arquivo(end-2:end);
        if (extensao == "mat")
            image_vector{i} = load(nome_arquivo); % Le o ficheiro e armazena-o no vetor
        else
        image_vector{i} = imread(nome_arquivo); % Le a imagem e armazena-a no vetor
        end
    end
    vetores_de_imagens{k} = image_vector;% Armazena o vetor de imagens desta subpasta no vetor principal
end

%Tenta remover as linhas
for i=1:25
Image = im2double(vetores_de_imagens{2}{1,i});
Image_gray = im2gray(Image);
Image_gray2 = Image_gray;
Box = double(vetores_de_imagens{3}{1,i});

SE2 = strel('disk', 10);
Image_bottom = imbothat(Image_gray, SE2);

% subplot(2,4,1);imshow(Image_gray); title('Original Gray');subplot(2,4,2);imshow(Image_bottom); title('Bottom')

% Início do Clustering
[m n]=kmeans(Image_bottom(:),3);
% m=reshape(m,size(Image_bottom,1),size(Image_bottom,2));
colors = [0 0 0; 1 0 0; 1 1 1];
% Bb=labeloverlay(Image_bottom,m,'Colormap',colors);
% subplot(3,3,3); imshow(Bb); %imagem a preto e branco, sem linhas, com a deteção do clustering 
% title('imagem a preto e branco, sem linhas, com a deteção do clustering ')


m=reshape(m,size(Image_gray,1),size(Image_gray,2));
Bg=labeloverlay(Image_gray,m,'Colormap',colors);
figure
subplot(3,1,1); %imagem a preto e branco com a deteção do clustering 
imshow(Bg);
title('imagem a preto e branco com a deteção do clustering')

% celulas = (m == 3);
% BgC=labeloverlay(Image_gray,celulas,'Colormap',[0 0 0]);
% subplot(3,3,5); %imagem a preto e branco com as células detetadas pelo clustering
% imshow(BgC);
% title('imagem a preto e branco com as células detetadas pelo clustering')

% BoC=labeloverlay(Image,celulas,'Colormap',[0 0 0]);
% subplot(3,3,6); %imagem original com as células detetadas pelo clustering 
% imshow(BoC);
% title('imagem original com as células detetadas pelo clustering ')


Image_thresh=imbinarize(im2gray(Bg));


subplot(3,1,2)
imshow(Image_thresh)
title('imagem em que começa a circle detection')
[centers, radii] = imfindcircles(Image_thresh, [15 800]); %deteção das células

% Visualizar círculos detectados antes da verificação de ROI
subplot(3,1,3)
imshow(Image_thresh);
viscircles(centers, radii, 'EdgeColor', 'b');
title('Círculos Detectados Inicialmente');
pause(0.5)
end
